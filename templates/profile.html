<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }}'s Profile - 90's Game Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7; --primary-light: #8579e8; --secondary: #a29bfe;
            --accent: #fd79a8; --accent-light: #fe8db6; --dark: #2d3436;
            --darker: #1e272e; --light: #f5f6fa; --light-gray: #dfe6e9;
            --success: #00b894; --danger: #d63031; --warning: #fdcb6e;
            --info: #0984e3; --gold: #f9ca24;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--darker); color: var(--light); overflow-x: hidden; min-height: 100vh; position: relative; }
        .gradient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3;
            background: linear-gradient(-45deg, #1e272e, #2d3436, #6c5ce7, #fd79a8);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 3rem 2rem; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .profile-header {
            display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem; background: rgba(45, 52, 54, 0.7);
            padding: 2rem; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
        }
        .profile-avatar {
            width: 120px; height: 120px; flex-shrink: 0; border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--accent)); display: flex;
            justify-content: center; align-items: center; font-size: 4rem; font-weight: 700;
            color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .profile-info h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .profile-info p { font-size: 1rem; color: var(--secondary); margin: 5px 0; }
        .profile-actions { margin-left: auto; display: flex; gap: 1rem; }
        .action-btn {
            background: transparent; color: var(--light); border: 1px solid var(--light); padding: 0.6rem 1.5rem;
            border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .action-btn.primary { border-color: var(--accent); color: var(--accent); }
        .action-btn:hover { background: var(--light); color: var(--darker); }
        .action-btn.primary:hover { background: var(--accent); color: white; }
        .section-title {
            font-size: 2rem; margin-bottom: 2rem; position: relative; display: inline-block; font-weight: 700;
        }
        .section-title::after {
            content: ''; position: absolute; bottom: -10px; left: 0; width: 60px; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 2px;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: rgba(45, 52, 54, 0.7); border-radius: 15px; padding: 2rem; text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .stat-icon { font-size: 2rem; color: var(--primary); margin-bottom: 1rem; }
        .stat-number { font-size: 2.2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; word-wrap: break-word; }
        .stat-label { font-size: 1rem; color: var(--light-gray); }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .achievement-card {
            display: flex; align-items: center; gap: 1rem; background: rgba(45, 52, 54, 0.7); padding: 1rem;
            border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); opacity: 0.5;
            filter: grayscale(80%); transition: all 0.3s ease;
        }
        .achievement-card.unlocked { opacity: 1; filter: grayscale(0%); border-left: 5px solid var(--gold); }
        .achievement-icon { font-size: 2.5rem; color: var(--gold); }
        .achievement-info h4 { margin-bottom: 0.2rem; color: var(--light); }
        .achievement-info p { font-size: 0.8rem; color: var(--secondary); }
        .played-games-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .sort-buttons button {
            background: var(--dark); color: var(--light); border: 1px solid var(--secondary); padding: 0.4rem 1rem;
            border-radius: 20px; cursor: pointer; margin-left: 0.5rem; transition: all 0.2s ease;
        }
        .sort-buttons button:hover, .sort-buttons button.active { background: var(--primary); border-color: var(--primary); }
        .played-games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .game-card {
            background: rgba(45, 52, 54, 0.7); border-radius: 15px; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease;
            display: flex; flex-direction: column;
        }
        .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(108, 92, 231, 0.2); border-color: var(--primary); }
        .game-card.favorite { border-color: var(--gold); box-shadow: 0 0 25px rgba(249, 202, 36, 0.3); }
        .game-card-info { padding: 1.5rem; flex-grow: 1; }
        .game-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .game-title { font-size: 1.4rem; }
        .favorite-icon { color: var(--gold); font-size: 1.5rem; }
        .game-details { font-size: 0.9rem; color: var(--secondary); list-style: none; padding-left: 0; }
        .game-details li { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .no-content {
            grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--secondary); font-size: 1.2rem;
            background: rgba(45, 52, 54, 0.5); border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>

    <div class="container">
        <header class="profile-header">
            <div class="profile-avatar">{{ user.username[0]|upper }}</div>
            <div class="profile-info">
                <h1>{{ user.username }}</h1>
                <p>Member Since: {{ user.created_at_formatted }}</p>
                <p>Last Login: {{ user.last_login_formatted }}</p>
            </div>
            <div class="profile-actions">
                <a href="{{ url_for('index') }}" class="action-btn">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="{{ url_for('logout') }}" class="action-btn primary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </header>

        {# Set favorite_game based on highest play count. Only runs if plays exist. #}
        {% if plays %}
            {% set favorite_game = plays|max(attribute='plays') %}
        {% else %}
            {% set favorite_game = None %}
        {% endif %}

        <section>
            <h2 class="section-title">Gaming Statistics üìä</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-gamepad"></i></div>
                    <div class="stat-number" id="total-plays">{{ total_play_count }}</div>
                    <div class="stat-label">Total Plays</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
                    <div class="stat-number" id="unique-games">{{ total_games_played }}</div>
                    <div class="stat-label">Unique Games</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-number" id="total-time">{{ total_play_time_formatted }}</div>
                    <div class="stat-label">Total Play Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-star"></i></div>
                    <div class="stat-number" id="favorite-game">{% if favorite_game %}{{ favorite_game.game_title }}{% else %}-{% endif %}</div>
                    <div class="stat-label">Favorite Game</div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="section-title">Achievements üèÜ</h2>
            <div class="achievements-grid" id="achievements-list">
                {# Achievements will be dynamically generated by JavaScript #}
            </div>
        </section>

        <section>
             <div class="played-games-header">
                <h2 class="section-title">Played Games üïπÔ∏è</h2>
                <div class="sort-buttons" id="sort-btns">
                    <button id="sort-name" class="active" title="Sort by Name">Name <i class="fas fa-sort-alpha-down"></i></button>
                    <button id="sort-plays" title="Sort by Plays">Plays <i class="fas fa-sort-numeric-down"></i></button>
                    <button id="sort-time" title="Sort by Time Played">Time <i class="fas fa-sort-amount-down"></i></button>
                </div>
            </div>
            <div class="played-games-grid" id="played-games-list">
                {% if plays %}
                    {% for play in plays %}
                        <div class="game-card {% if favorite_game and play.game_title == favorite_game.game_title %}favorite{% endif %}"
                             data-name="{{ play.game_title }}"
                             data-plays="{{ play.plays }}"
                             data-duration="{{ play.total_duration }}">
                            <div class="game-card-info">
                                <div class="game-title-container">
                                    <h3 class="game-title">{{ play.game_title }}</h3>
                                    {% if favorite_game and play.game_title == favorite_game.game_title %}
                                        <i class="fas fa-crown favorite-icon" title="Favorite Game"></i>
                                    {% endif %}
                                </div>
                                <ul class="game-details">
                                    <li><i class="fas fa-gamepad"></i>Played <strong>{{ play.plays }}</strong> time(s)</li>
                                    <li><i class="fas fa-clock"></i>Total Duration: <strong>{{ play.total_duration_formatted }}</strong></li>
                                    <li><i class="fas fa-calendar-alt"></i>Last Played: <strong>{{ play.last_played_formatted }}</strong></li>
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-content">You haven't played any games yet. Go play some!</p>
                {% endif %}
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA FROM SERVER (Rendered in HTML) ---
        const stats = {
            totalPlays: parseInt(document.getElementById('total-plays')?.textContent || '0', 10),
            uniqueGames: parseInt(document.getElementById('unique-games')?.textContent || '0', 10),
            // Find max plays from the rendered game cards for achievement logic
            maxPlays: 0
        };

        const gameCards = Array.from(document.querySelectorAll('.game-card'));
        if (gameCards.length > 0) {
            const playCounts = gameCards.map(card => parseInt(card.dataset.plays, 10));
            stats.maxPlays = Math.max(...playCounts);
        }

        // --- RENDER DYNAMIC UI COMPONENTS ---
        triggerStatAnimations();
        renderAchievements(stats);
        setupSortEventListeners();
    });

    // --- UI FUNCTIONS ---

    function triggerStatAnimations() {
        animateValue('total-plays', 1000);
        animateValue('unique-games', 1000);
    }

    function renderAchievements(stats) {
        const achievementList = document.getElementById('achievements-list');
        if (!achievementList) return;

        const allAchievements = [
            { id: 'first-game', icon: 'fa-gamepad', title: 'First Steps', desc: 'Play your first game', unlocked: stats.totalPlays >= 1 },
            { id: 'collector', icon: 'fa-layer-group', title: 'Collector', desc: 'Play 5 unique games', unlocked: stats.uniqueGames >= 5 },
            { id: 'veteran', icon: 'fa-trophy', title: 'Veteran', desc: 'Play 10 unique games', unlocked: stats.uniqueGames >= 10 },
            { id: 'dedicated', icon: 'fa-heart', title: 'Dedicated', desc: 'Play one game 10 times', unlocked: stats.maxPlays >= 10 },
            { id: 'master', icon: 'fa-crown', title: 'Master', desc: 'Play one game 25 times', unlocked: stats.maxPlays >= 25 },
            { id: 'high-score', icon: 'fa-chart-line', title: 'High Scorer', desc: 'Reach 50 total plays', unlocked: stats.totalPlays >= 50 }
        ];

        let achievementsHTML = '';
        const unlockedCount = allAchievements.filter(a => a.unlocked).length;

        if (unlockedCount > 0) {
            allAchievements.forEach(ach => {
                achievementsHTML += `
                    <div class="achievement-card ${ach.unlocked ? 'unlocked' : ''}">
                        <div class="achievement-icon"><i class="fas ${ach.icon}"></i></div>
                        <div class="achievement-info">
                            <h4>${ach.title}</h4>
                            <p>${ach.desc}</p>
                        </div>
                    </div>
                `;
            });
        } else {
            achievementsHTML = '<p class="no-content">No achievements yet. Keep playing!</p>';
        }
        achievementList.innerHTML = achievementsHTML;
    }

    function setupSortEventListeners() {
        const sortButtons = document.querySelector('.sort-buttons');
        const gameGrid = document.getElementById('played-games-list');
        if (!sortButtons || !gameGrid) return;

        sortButtons.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            // Update active button state
            sortButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Get game cards and sort
            const cards = Array.from(gameGrid.querySelectorAll('.game-card'));
            let sortKey = button.id.replace('sort-', ''); // 'name', 'plays', 'time'

            cards.sort((a, b) => {
                let valA, valB;
                if (sortKey === 'name') {
                    valA = a.dataset.name;
                    valB = b.dataset.name;
                    return valA.localeCompare(valB);
                } else if (sortKey === 'plays') {
                    valA = parseInt(a.dataset.plays, 10);
                    valB = parseInt(b.dataset.plays, 10);
                    return valB - valA; // Descending
                } else if (sortKey === 'time') {
                     valA = parseFloat(a.dataset.duration);
                     valB = parseFloat(b.dataset.duration);
                     return valB - valA; // Descending
                }
                return 0;
            });

            // Re-append sorted cards to the grid
            cards.forEach(card => gameGrid.appendChild(card));
        });

         // Trigger default sort
        document.getElementById('sort-name').click();
    }


    // --- HELPER FUNCTIONS ---

    function animateValue(id, duration) {
        const obj = document.getElementById(id);
        if (!obj) return;

        const endValue = parseInt(obj.textContent.replace(/,/g, ''), 10);
        if (isNaN(endValue)) return; // Don't animate non-numeric values

        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * endValue).toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        obj.textContent = '0'; // Start animation from 0
        window.requestAnimationFrame(step);
    }
    </script>
</body>
</html>